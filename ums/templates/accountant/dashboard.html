{% extends 'accountant/base_accountant.html' %}
{% block title %}Accountant Dashboard | UMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Accountant Dashboard</h1>
    <span class="text-muted">Welcome, {{ user.get_full_name }}</span>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm h-100">
            <div class="card-body">
                <i class="bi bi-cash-stack fs-1 float-end opacity-50"></i>
                <h6 class="card-title text-uppercase opacity-75">Total Collected</h6>
                <h2 class="display-5 fw-bold mb-0">₹{{ total_collected|floatformat:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger shadow-sm h-100">
            <div class="card-body">
                <i class="bi bi-exclamation-triangle fs-1 float-end opacity-50"></i>
                <h6 class="card-title text-uppercase opacity-75">Pending Dues</h6>
                <h2 class="display-5 fw-bold mb-0">₹{{ total_pending|floatformat:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body">
                <i class="bi bi-receipt fs-1 float-end opacity-50"></i>
                <h6 class="card-title text-uppercase opacity-75">This Month</h6>
                <h2 class="display-5 fw-bold mb-0">₹{{ this_month_collected|floatformat:0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm h-100">
            <div class="card-body">
                <i class="bi bi-people fs-1 float-end opacity-50"></i>
                <h6 class="card-title text-uppercase opacity-75">Total Students</h6>
                <h2 class="display-5 fw-bold mb-0">{{ total_students }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Monthly Revenue Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2 text-success"></i>Monthly Revenue ({{ current_year }})
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end" style="height: 250px;">
                    {% for month in monthly_data %}
                    <div class="col text-center px-1">
                        <div class="d-flex flex-column align-items-center justify-content-end h-100">
                            <small class="fw-bold mb-1" style="font-size: 0.65rem;">
                                {% if month.amount > 0 %}₹{{ month.amount|floatformat:0 }}{% endif %}
                            </small>
                            <div class="bg-success rounded-top w-100"
                                style="height: {{ month.height }}%; min-height: {% if month.amount > 0 %}8{% else %}2{% endif %}px; opacity: 0.8;"
                                data-bs-toggle="tooltip" title="₹{{ month.amount|floatformat:0 }}">
                            </div>
                            <small class="mt-1 text-muted" style="font-size: 0.7rem;">{{ month.label }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-lightning me-2 text-warning"></i>Quick Actions</h5>
            </div>
            <div class="card-body d-flex flex-column gap-3">
                <a href="{% url 'accountant_collect_fees' %}" class="btn btn-success btn-lg w-100">
                    <i class="bi bi-cash-coin me-2"></i>Collect Fees
                </a>
                <a href="{% url 'accountant_payment_history' %}" class="btn btn-outline-primary btn-lg w-100">
                    <i class="bi bi-clock-history me-2"></i>Payment History
                </a>
                <a href="{% url 'accountant_reports' %}" class="btn btn-outline-info btn-lg w-100">
                    <i class="bi bi-bar-chart me-2"></i>Financial Reports
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Recent Transactions</h5>
        <a href="{% url 'accountant_payment_history' %}" class="btn btn-sm btn-outline-primary">View All</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Receipt #</th>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Mode</th>
                        <th class="text-end">Amount</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pay in recent_payments %}
                    <tr>
                        <td><span class="badge bg-secondary">{{ pay.receipt_no }}</span></td>
                        <td>
                            <strong>{{ pay.student.user.get_full_name }}</strong>
                            <br><small class="text-muted">{{ pay.student.enrollment_no }}</small>
                        </td>
                        <td>{{ pay.payment_date|date:"d M Y" }}</td>
                        <td><span class="badge bg-info text-dark">{{ pay.get_payment_mode_display }}</span></td>
                        <td class="text-end fw-bold">₹{{ pay.amount_paid|floatformat:0 }}</td>
                        <td class="text-center">
                            {% if pay.status == 'PAID' %}
                            <span class="badge bg-success">Paid</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">No transactions yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
</script>
{% endblock %}